<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Backups</title>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark"><div class="container-fluid"><a class="navbar-brand">Gerenciador de Backups</a></div></nav>
    <div class="container mt-4">
        <h1 class="mb-4">Painel de Controle</h1>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2>Contêineres Ativos</h2>
        {% if containers %}
            <table class="table table-hover">
                <thead class="table-dark"><tr><th>Nome</th><th>ID</th><th>Imagem</th><th>Ações</th></tr></thead>
                <tbody>
                {% for c in containers %}
                    <tr><td>{{ c.nome }}</td><td>{{ c.id }}</td><td>{{ c.imagem }}</td><td><a href="{{ url_for('principal.backup', container_id=c.id) }}" class="btn btn-primary btn-sm">Fazer Backup</a></td></tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-warning">Nenhum contêiner de banco de dados ativo.</div>
        {% endif %}

        <h2 class="mt-5">Backups Existentes</h2>
        {% if backups %}
            <table class="table table-hover">
                <thead class="table-dark"><tr><th>Arquivo</th><th>Data</th><th>Tamanho (KB)</th><th>Ações</th></tr></thead>
                <tbody>
                {% for b in backups %}
                    <tr>
                        <td>{{ b.nome_arquivo }}</td><td>{{ b.data }}</td><td>{{ b.tamanho_kb }}</td>
                        <td>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalRestauracao" data-filename="{{ b.nome_arquivo }}">Restaurar</button>
                            <a href="{{ url_for('principal.excluir', nome_arquivo=b.nome_arquivo) }}" class="btn btn-danger btn-sm" onclick="return confirm('Excluir este backup? A ação é irreversível.');">Excluir</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-info">Nenhum backup criado.</div>
        {% endif %}
    </div>

    <div class="modal fade" id="modalRestauracao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Confirmar Restauração</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <form action="{{ url_for('principal.restaurar') }}" method="POST">
                    <div class="modal-body">
                        <p>Restaurar backup: <br><strong><span id="filename-span"></span></strong></p>
                        <p class="text-danger fw-bold">ATENÇÃO: Os dados no contêiner de destino serão substituídos.</p>
                        <input type="hidden" name="nome_arquivo" id="hidden-filename-input">
                        <div class="mb-3">
                            <label for="container_id_destino" class="form-label">Selecione o contêiner de DESTINO:</label>
                            <select class="form-select" name="container_id_destino" required>
                                <option value="" disabled selected>Escolha um contêiner...</option>
                                {% for c in containers %}<option value="{{ c.id }}">{{ c.nome }} ({{ c.imagem }})</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Confirmar e Restaurar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const modalRestauracao = document.getElementById('modalRestauracao');
        modalRestauracao.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const filename = button.getAttribute('data-filename');
            modalRestauracao.querySelector('#filename-span').textContent = filename;
            modalRestauracao.querySelector('#hidden-filename-input').value = filename;
        });
    </script>
</body>
</html>
</body>
</html>