{% extends "base.html" %}

{% block title %}Painel de Controle - Gerenciador de Backups{% endblock %}

{% block content %}
<h1 class="mb-4">Painel de Controle</h1>

<div class="row">
    <div class="col-lg-12">
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="fas fa-server me-2"></i>Contêineres Ativos</h2>
            </div>
            <div class="card-body">
                <p class="card-text">Contêineres de banco de dados em execução.</p>
                {% if containers %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome do Contêiner</th>
                                    <th>ID</th>
                                    <th>Imagem</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for container in containers %}
                                <tr>
                                    <td>{{ container.nome }}</td>
                                    <td><span class="badge bg-secondary">{{ container.id }}</span></td>
                                    <td>{{ container.imagem }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('principal.backup', container_id=container.id) }}" class="btn btn-primary btn-sm">
                                            <i class="fas fa-play-circle me-1"></i> Fazer Backup Agora
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>Nenhum contêiner de banco de dados ativo encontrado. Verifique se o serviço Docker está em execução.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="far fa-calendar-alt me-2"></i>Agendamento de Backups</h2>
            </div>
            <div class="card-body">
                <form action="{{ url_for('principal.agendar') }}" method="POST">
                    <div class="mb-3">
                        <label for="container_id" class="form-label">Selecione o Contêiner</label>
                        <select class="form-select" id="container_id" name="container_id" required>
                            <option value="" disabled selected>Escolha um contêiner...</option>
                            {% for c in containers %}
                                <option value="{{ c.id }}|{{ c.nome }}">{{ c.nome }} ({{ c.imagem }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="backup_time" class="form-label">Horário do Backup (diário)</label>
                        <input type="time" class="form-control" id="backup_time" name="backup_time" required>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-clock me-2"></i>Agendar</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="fas fa-list-alt me-2"></i>Agendamentos Ativos</h2>
            </div>
            <div class="card-body">
                {% if agendamentos %}
                    <ul class="list-group">
                        {% for agendamento in agendamentos %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ agendamento.nome }}</strong><br>
                                <small class="text-muted">Próxima execução: {{ agendamento.proxima_execucao }}</small>
                            </div>
                            <a href="{{ url_for('principal.excluir_agendamento', job_id=agendamento.id) }}" 
                               class="btn btn-danger btn-sm"
                               onclick="return confirm('Tem certeza que deseja remover este agendamento?');">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">Nenhum backup automático agendado.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="fas fa-history me-2"></i>Backups Existentes</h2>
            </div>
            <div class="card-body">
                {% if backups %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Arquivo</th>
                                    <th>Data de Criação</th>
                                    <th>Tamanho (KB)</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr>
                                    <td><i class="fas fa-file-archive text-primary me-2"></i>{{ backup.nome_arquivo }}</td>
                                    <td>{{ backup.data }}</td>
                                    <td>{{ backup.tamanho_kb }}</td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-success btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#modalRestauracao" 
                                                data-filename="{{ backup.nome_arquivo }}">
                                            <i class="fas fa-undo me-1"></i> Restaurar
                                        </button>
                                        <a href="{{ url_for('principal.excluir', nome_arquivo=backup.nome_arquivo) }}" 
                                           class="btn btn-danger btn-sm"
                                           onclick="return confirm('ATENÇÃO!\n\nVocê tem CERTEZA que deseja EXCLUIR o backup \'{{ backup.nome_arquivo }}\'? Esta ação é IRREVERSÍVEL.');">
                                            <i class="fas fa-trash-alt"></i> Excluir
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info" role="alert">
                       <i class="fas fa-info-circle me-2"></i> Nenhum backup foi criado ainda.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Restauração -->
<div class="modal fade" id="modalRestauracao" tabindex="-1" aria-labelledby="modalLabelRestauracao" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabelRestauracao"><i class="fas fa-undo me-2"></i>Confirmar Restauração</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('principal.restaurar') }}" method="POST">
                <div class="modal-body">
                    <p>Você está prestes a restaurar o backup:
                       <br><strong><span id="filename-span"></span></strong>
                    </p>
                    <p class="text-danger fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>ATENÇÃO: Esta ação substituirá permanentemente os dados no contêiner de destino.</p>
                    
                    <input type="hidden" name="nome_arquivo" id="hidden-filename-input">

                    <div class="mb-3">
                        <label for="container_id_destino" class="form-label">Selecione o contêiner de DESTINO:</label>
                        <select class="form-select" name="container_id_destino" id="container_id_destino" required>
                            <option value="" disabled selected>Escolha um contêiner...</option>
                            {% for c in containers %}
                                <option value="{{ c.id }}">{{ c.nome }} ({{ c.imagem }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-check-circle me-2"></i>Confirmar e Restaurar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modalRestauracao = document.getElementById('modalRestauracao');
    modalRestauracao.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const filename = button.getAttribute('data-filename');
        modalRestauracao.querySelector('#filename-span').textContent = filename;
        modalRestauracao.querySelector('#hidden-filename-input').value = filename;
    });
</script>
{% endblock %}